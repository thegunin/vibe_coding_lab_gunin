# Telegram Feedback Bot

Бот для сбора командной обратной связи с ролями «руководитель» и «сотрудник». Реализованы:
– вход с демо-аккаунтами и привязкой к Telegram user_id,
– создание вопросов руководителем и отслеживание ответов,
– ответы сотрудников с оценкой 1–5 и возможностью изменить, пока вопрос активен,
– мгновенные уведомления руководителю и просмотр истории уведомлений,
– отправка свободной обратной связи сотрудниками с сохранением в базе,
– отчёты с агрегированной статистикой и экспортом CSV,
– хранение данных в SQLite, конфигурация через `.env`, расширенное логирование действий пользователей.

## Быстрый старт

1. Установите Python 3.10+.
2. Создайте виртуальное окружение и активируйте его.
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
4. Создайте файл `.env` (можно взять за основу пример в корне репозитория) и задайте значения:
   * `BOT_TOKEN` — токен вашего бота.
   * `PASSWORD_SALT` — произвольная (лучше случайная) строка.
   * `DATABASE_PATH` — путь к SQLite-файлу (по умолчанию `feedback_bot.db` в корне проекта).
   * `LOG_LEVEL` — уровень логирования (`INFO`, `DEBUG`, ...).
   * `RUN_MODE` — `polling` для локального режима или `webhook` для работы через ngrok/внешний URL.
   * `WEBHOOK_URL` — внешний URL (без пути), например `https://abc123.ngrok.io` при `RUN_MODE=webhook`.
   * `WEBHOOK_PATH` — путь для вебхука (по умолчанию `webhook` → конечный URL будет `https://abc123.ngrok.io/webhook`).
   * `WEBAPP_HOST` и `WEBAPP_PORT` — хост/порт локального веб-сервера (например, `0.0.0.0` и `8000`).
5. Запустите бота:
   ```bash
   python -m src.bot
   ```

При первом старте база создаётся автоматически и заполняется учётками:

| Роль         | Логин       | Пароль            |
|--------------|-------------|-------------------|
| Руководитель | manager     | manager-password  |
| Сотрудник    | employee-1  | employee-1        |
| Сотрудник    | employee-2  | employee-2        |
| Сотрудник    | employee-3  | employee-3        |

После входа Telegram user_id остаётся закреплённым до команды «Сменить аккаунт».

## Основные сценарии

- `/start` показывает основное меню с кнопками ReplyKeyboard по роли.
- Сотрудник:
  * `Вопросы` — список активных неотвеченных вопросов с inline-кнопками `[1–5]`.
  * `Мои ответы` — история с возможностью изменить ответ (пока вопрос активен).
  * `Оставить обратную связь` — свободный текст, который сохраняется и доступен менеджерам в базе.
- Руководитель:
  * `Создать вопрос` — ввод текста и мгновенное появление у сотрудников.
  * `Отчёты` — вопросы батчами по 10, детали, CSV и переключение статуса.
  * `Уведомления` — история уведомлений с отметкой о прочтении.

Ответы сотрудников автоматически создают уведомления, сохраняются в базе и шлются всем залогиненным руководителям.

## Локальный деплой через ngrok

1. Установите [ngrok](https://ngrok.com/), авторизуйтесь и выполните `ngrok config add-authtoken <ваш токен>`.
2. В `.env` установите:
   * `RUN_MODE=webhook`
   * `WEBHOOK_URL=https://<адрес>.ngrok.io`
   * (при необходимости скорректируйте `WEBHOOK_PATH`, `WEBAPP_HOST`, `WEBAPP_PORT`)
3. Запустите локальный веб-сервер бота:
   ```bash
   python -m src.bot
   ```
4. Поднимите туннель: `ngrok http 8000`.
5. Настройте вебхук в Telegram:
   ```
   https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook?url=https://<адрес>.ngrok.io/webhook
   ```
6. Проверьте логи в консоли/`http://127.0.0.1:4040`, откройте бота в Telegram и протестируйте сценарии — все вебхук-запросы будут отображаться в ngrok Inspector.

## Журналирование

- Все ключевые действия пользователей (логин, ответы, отправка обратной связи, управление вопросами) пишутся в стандартный лог Python.
- При запуске в режиме `webhook` запросы Telegram проходят через ngrok, поэтому их можно анализировать в инспекторе (`http://127.0.0.1:4040`) вместе с логами приложения в консоли.

## Полезные команды

- `Отмена` — прервать текущий диалог (например, ввод вопроса или логина).
- `Сменить аккаунт` — отвязать Telegram user_id от привязанной учётки.

## Структура проекта

- `src/config.py` — загрузка конфигурации из `.env`.
- `src/security.py` — SHA256-хеширование паролей.
- `src/database.py` — создание схемы SQLite, запросы и уведомления.
- `src/bot.py` — Telegram-бизнес-логика на `python-telegram-bot`.
